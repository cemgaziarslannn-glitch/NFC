<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CGA GÃ¼venlik Sistemi - GÃ¼venlik Paneli</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<style>
  body { margin:0; font-family:'Montserrat', sans-serif; background: linear-gradient(135deg, #2c3e50, #34495e); color:#ecf0f1; overflow-x:hidden; }
  .container { display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding:20px; transition: transform 0.3s ease; }
  header { text-align:center; margin-bottom:20px; }
  button { padding:12px 18px; margin:6px; border-radius:10px; border:none; cursor:pointer; font-weight:600; transition:0.3s; }
  button:hover { opacity:0.9; }
  #nobetAlBtn { background-color: #2980b9; color:#fff; }
  #nobetBitirBtn { background-color: #c0392b; color:#fff; }
  #devriyeStartBtn { background-color: #2980b9; color:#fff; }
  #devriyeEndBtn { background-color: #c0392b; color:#fff; }
  .status { margin:12px 0; padding:12px; background: rgba(0,0,0,0.2); border-radius:10px; width:100%; text-align:center; font-size:16px; }
  .panel { background: rgba(255,255,255,0.05); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.4); width:100%; margin-top:20px; }
  .panel h2 { margin-top:0; text-align:center; }
  .qr-list div { margin-bottom:12px; display:flex; align-items:center; justify-content:space-between; }
  .qr-list button.qrBtn { background-color: #7f8c8d; color:#fff; flex-shrink:0; width:120px; }
  .qr-list button.qrBtn.read { background-color:#27ae60; }

  input[type=date], input[type=text], input[type=password] { padding:6px; border-radius:8px; border:none; font-size:14px; }

  /* Tek ikonlu saÄŸ panel */
  #historyToggleBtn {
    position:fixed; top:20px; right:20px; background:#f39c12; color:#fff;
    border:none; border-radius:50%; width:50px; height:50px;
    font-size:24px; z-index:1001; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
  }
  #logoutTopBtn {
  position: fixed;
  top: 20px;
  right: 80px; /* geÃ§miÅŸ butonunun yanÄ±na */
  background: #c0392b;
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  font-size: 22px;
  cursor: pointer;
  z-index: 1001;
  display: flex;
  align-items: center;
  justify-content: center;
}
#kayitBtn {
  position: fixed;
  top: 20px;
  right: 140px;
  background: #3498db;
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 55px;
  height: 55px;
  font-size: 30px;
  cursor: pointer;
  z-index: 1001;

  /* ğŸ”¥ Firebase durumuna gÃ¶re JS ile aÃ§/kapa */
  display: none;

  /* ğŸ“ Tam ortalama */
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  line-height: 1; /* ğŸ”¥ 55px deÄŸil â†’ emoji kayÄ±yor, bu daha iyi */
  padding: 0;
}



  #historyPanel {
    position:fixed; top:0; right:-100%;
    width:320px; height:100%;
    background: rgba(44,62,80,0.95);
    color:#fff;
    box-shadow: -6px 0 20px rgba(0,0,0,0.4);
    padding:20px;
    transition: right 0.3s ease;
    overflow-y:auto;
    z-index:1000;
  }
  #historyPanel h2 { text-align:center; margin-top:0; }

  .profileIcon {
    position:fixed; top:20px; left:20px; background:#16a085; color:#fff;
    border:none; border-radius:50%; width:50px; height:50px;
    font-size:24px; z-index:1001; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
  }

  @media (min-width:600px){
    .container { max-width:600px; margin:auto; }
  }

  /* === QR KAMERA MODALI (Tam Ekran) === */
  #qrScannerModal {
    display:none; position:fixed; inset:0; background:#000; z-index:9999;
 flex-direction:column; align-items:center; justify-content:center;
    padding:16px;
  }
  #qr-reader { width:100%; max-width:520px; }
  #closeScanner {
    margin-top:20px; padding:12px 18px; border:none; border-radius:10px;
    background:#c0392b; color:#fff; font-weight:700; cursor:pointer;
  }

  /* Kargo bildirimleri stili */
  #kargoPanel { background: rgba(255,255,255,0.05); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.4); width:100%; margin-top:20px; }
  .kargo-item { display:flex; justify-content:space-between; align-items:center; background: rgba(0,0,0,0.2); padding:10px; border-radius:10px; margin-bottom:10px; }
  .kargo-item button { background:#27ae60; color:#fff; border:none; padding:6px 12px; border-radius:8px; cursor:pointer; }
  /* TÃ¼m sayfa metinlerini seÃ§ilemez yap */
body, div, span, p, h1, h2, h3, h4, h5, h6, label, input, button {
    user-select: none;
    -webkit-user-select: none; /* Safari/Chrome */
    -moz-user-select: none;    /* Firefox */
    -ms-user-select: none;     /* IE/Edge */
}
.site-name{
  display:none;
  text-align:center;
  font-size:26px;
  font-weight:800;
  margin:10px 0 20px;
  color:#2ecc71;
  letter-spacing:1px;
  text-shadow:
    0 0 10px rgba(46,204,113,0.6),
    0 0 25px rgba(46,204,113,0.4);
  animation: glowIn .6s ease;
}

@keyframes glowIn{
  from{
    opacity:0;
    transform:translateY(-6px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}
/* ğŸ“± MOBÄ°LDE BAÅLIKLARI AÅAÄI AL */
@media (max-width: 600px) {
  header {
    margin-top: 80px;
  }
}
/* Site adÄ± animasyonlu gÃ¶rÃ¼n / kaybol */
.site-name {
  display: none;
  text-align: center;
  font-size: 22px;
  font-weight: 700;
  margin: 6px 0 10px;
  color: #2ecc71;
  letter-spacing: 1px;
  text-shadow:
    0 0 10px rgba(46,204,113,0.6),
    0 0 25px rgba(46,204,113,0.4);
  animation: slideFadeIn 0.6s ease forwards;
}

@keyframes slideFadeIn {
  from {
    opacity: 0;
    transform: translateY(-8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Kaybolurken */
.site-name.hide {
  animation: slideFadeOut 0.5s ease forwards;
}

@keyframes slideFadeOut {
  from {
    opacity: 1;
    transform: translateY(0);
  }
  to {
    opacity: 0;
    transform: translateY(-6px);
  }
}
@keyframes blinkRed {
  0% { box-shadow: 0 0 10px 2px rgba(192,57,43,0.7); }
  50% { box-shadow: 0 0 20px 5px rgba(192,57,43,1); }
  100% { box-shadow: 0 0 10px 2px rgba(192,57,43,0.7); }
}

.nobet-offline {
  background-color: #c0392b !important;
  animation: blinkRed 1s infinite;
  color: #fff;
  font-weight: 700;
  text-shadow: 0 0 8px rgba(255,255,255,0.6);
}


.blink-red {
  border: 2px solid #c0392b !important;
  animation: blinkRed 1s infinite;
  background-color: rgba(192,57,43,0.1);
  color: #e74c3c; /* metin de kÄ±rmÄ±zÄ± yanacak */
}

@keyframes blinkRed {
  0%, 100% { box-shadow: 0 0 10px #c0392b; }
  50% { box-shadow: 0 0 20px #e74c3c; }
}
@keyframes blinkRedSlow {
  0%, 100% { color: #c0392b; }
  50% { color: #e74c3c; }
}

.offlineTextBlink {
  animation: blinkRedSlow 2s infinite; /* yavaÅŸ yanÄ±p sÃ¶nme */
  font-size: 16px;      /* varsayÄ±lan boyut */
  white-space: nowrap;   /* tek satÄ±r */
  overflow: hidden;
  text-overflow: ellipsis;
}

@media (max-width: 600px){
  .offlineTextBlink {
    font-size: 12px; /* mobilde kÃ¼Ã§Ã¼ltÃ¼ldÃ¼ */
  }
}
/* Mobilde devriye butonlarÄ± dÃ¼zeni */
@media (max-width: 600px) {
  .panel button {
    width: 100% !important;      /* Tam geniÅŸlik */
    margin: 8px 0 !important;    /* Ãœst-alt boÅŸluk */
    padding: 12px 0 !important;  /* Daha bÃ¼yÃ¼k tÄ±klanabilir alan */
    font-size: 16px !important;  /* YazÄ± okunabilir */
    border-radius: 12px !important;
  }

  /* Olay ve Kargo butonlarÄ±nÄ± daha uyumlu yap */
  #olayBtn {
    background: #f39c12 !important;  /* turuncu */
    color: #fff !important;
  }

  #kargoBtn {
    background: #e67e22 !important;  /* biraz daha soft turuncu */
    color: #fff !important;
    position: relative;
  }

  /* Kargo rozeti konumu mobilde kÃ¼Ã§Ã¼lt */
  #kargoBadge {
    top: -4px;
    right: -4px;
    font-size: 10px;
    padding: 1px 4px;
  }
}
.qr-list button {
  width: auto !important;
  padding: 6px 12px !important;
  font-size: 14px !important;
}
/* Parlama Efekti */
.pulse-blue {
  animation: pulse-animation 2s infinite;
}

@keyframes pulse-animation {
  0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); }
  70% { box-shadow: 0 0 0 15px rgba(52, 152, 219, 0); }
  100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
}
</style>
</head>
<body>

<!-- Profil ikonu -->
<button class="profileIcon" id="profileBtn">&#128100;</button>

<!-- Tek ikon: Devriye GeÃ§miÅŸi -->
<button id="historyToggleBtn" title="Devriye GeÃ§miÅŸi">ğŸ’¾</button>
<button id="kayitBtn" style="display:none;">ğŸ“‹</button>
<button id="logoutTopBtn" title="Ã‡Ä±kÄ±ÅŸ">ğŸšª</button>


<div id="historyPanel">
  <h2>Devriye GeÃ§miÅŸi</h2>
  <label for="filterDate">Tarih Filtrele:</label>
  <input type="date" id="filterDate">
  <div id="devriyeHistory"></div>
</div>

<!-- Profil Modal -->
<div id="profileModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background: rgba(30,30,30,0.95); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.5); z-index:9999; width:90%; max-width:400px;">
  <span id="profileClose" style="position:absolute; top:10px; right:10px; cursor:pointer; font-size:18px; color:#fff;">âœ–</span>
  <h3 style="text-align:center;">Profil</h3>
  
  <label>KullanÄ±cÄ± AdÄ± (deÄŸiÅŸtirilemez)</label>
  <input type="text" id="profileUsername" disabled style="width:100%; padding:8px; border-radius:8px; border:none; background:#333; color:#fff; font-weight:600;">
  
 <label>Eski Åifre</label>
<div style="position:relative; width:100%; display:flex; align-items:center;">
  <input type="password" id="oldPassword" style="flex:1; padding:8px 40px 8px 8px; border-radius:8px; border:none;">
  <span class="togglePassword" data-target="oldPassword" style="position:absolute; right:8px; cursor:pointer;">ğŸ‘€</span>
</div>

<label>Yeni Åifre</label>
<div style="position:relative; width:100%; display:flex; align-items:center;">
  <input type="password" id="newPassword" style="flex:1; padding:8px 40px 8px 8px; border-radius:8px; border:none;">
  <span class="togglePassword" data-target="newPassword" style="position:absolute; right:8px; cursor:pointer;">ğŸ‘€</span>
</div>

  
  <label>Telefon NumarasÄ±</label>
  <input type="text" id="phoneNumber" placeholder="+90..." style="width:100%; padding:8px; border-radius:8px; border:none;">
  
  <button id="updateProfileBtn" style="width:100%; padding:10px; margin-top:12px; border:none; border-radius:8px; background:#27ae60; color:#fff; font-weight:600;">GÃ¼ncelle</button>

  <div id="profileMessage" style="margin-top:10px; font-size:14px;"></div>
</div>

<div class="container" id="mainContainer">
<header>
  <h1 class="main-title">CGA GÃ¼venlik Sistemi</h1>
  <div id="siteName" class="site-name"></div>
  <h2 class="sub-title">GÃ¼venlik Paneli</h2>
</header>

  <!-- NÃ¶bet -->
  <button id="nobetAlBtn">NÃ¶beti Teslim Al</button>
  <button id="nobetBitirBtn" disabled>NÃ¶beti Teslim Et</button>
  <div class="status" id="nobetStatus">HenÃ¼z nÃ¶bette deÄŸilsiniz.</div>
  <div id="nobetTimer" style="margin-top:8px; font-weight:bold;"></div>


  <!-- Devriye -->
  <div class="panel">
    <h2>Devriye</h2>
    <button id="devriyeStartBtn">Devriye BaÅŸlat</button>
    <button id="devriyeEndBtn" disabled>Devriyeyi Bitir</button>
	 <button id="olayBtn" style="background:#f39c12; color:#fff;">Olay Bildir</button> 



    <div class="status" id="devriyeStatus">Devriye baÅŸlamadÄ±.</div>

    <h3>Devriye NoktalarÄ±</h3>
    <div class="qr-list" id="qrListContainer"></div>
  </div>

 

<!-- === QR KamerasÄ± ModalÄ± === -->
<div id="qrScannerModal">
  <div id="qr-reader"></div>
  <button id="closeScanner">Kapat</button>
  <button id="flashToggle" style="
  margin-top:10px;
  padding:12px 18px;
  border:none;
  border-radius:10px;
  background:#f1c40f;
  color:#000;
  font-weight:700;
">
ğŸ”¦ FlaÅŸ AÃ§
</button>

</div>
<!-- Devriye uyarÄ± modalÄ± -->
<div id="warningModal" style="
    display:none;
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    background: rgba(231, 76, 60, 0.95); /* hafif saydam kÄ±rmÄ±zÄ± */
    color: #fff;
    padding: 16px 24px;
    border-radius: 16px;
    font-size: 15px;
    font-weight: 600;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    z-index: 9999;
    text-align: center;
    max-width: 90%;
    width: auto;
    word-wrap: break-word;
    line-height: 1.4;
    transition: transform 0.3s ease, opacity 0.3s ease;
">
  Devriyeye baÅŸlamadan Ã¶nce nÃ¶beti almalÄ±sÄ±nÄ±z!
</div>


<!-- Html5Qrcode (kameralÄ± QR okuma) -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, push, set, update, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

/* === QR ile seÃ§ilen site Firebase === */
const siteID = localStorage.getItem("siteID");
const siteConfigStr = localStorage.getItem("siteConfig");

if (!siteID || !siteConfigStr) {
  alert("Site baÄŸlantÄ±sÄ± yok. LÃ¼tfen QR kodu tekrar okutunuz.");
  window.location.href = "index.html";
}
const siteConfig = JSON.parse(siteConfigStr);
let app = getApps().find(a => a.name === `siteApp-${siteID}`);
if (!app) {
  app = initializeApp(siteConfig, `siteApp-${siteID}`);
}
const db = getDatabase(app);
const siteNameEl = document.getElementById("siteName");
async function loadSiteName(){
  try{
    const snap = await get(ref(db, "settings/siteName"));
    if(!snap.exists()) return;
    const name = String(snap.val()).trim();
    if(!name) return;
    siteNameEl.textContent = name;
    siteNameEl.classList.remove('hide');
    siteNameEl.style.display = 'block';

    // â³ 10 saniye sonra kaybolsun
    setTimeout(() => {
      siteNameEl.classList.add('hide');

      // animasyon bitince DOMâ€™dan tamamen Ã§Ä±kar
      setTimeout(() => {
        siteNameEl.style.display = 'none';
        siteNameEl.classList.remove('hide');
      }, 500);

    }, 10000);

  } catch (e) {
    console.log("Site adÄ± okunamadÄ±");
  }
}
loadSiteName();
const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
if(!currentUser || currentUser.type!=='security'){
  alert("GÃ¼venlik kullanÄ±cÄ± ile giriÅŸ yapmalÄ±sÄ±nÄ±z!");
  window.location.href="index.html";
}
 const activeDevriyeRef = ref(db,'activeDevriye/'+(currentUser.username || currentUser.name));
// === Olay Bildir / Kargo Bildir iÃ§in nÃ¶bet kontrolÃ¼ ===
async function checkActiveNobet(){
    const snapshot = await get(nobetRecordsRef);
    const val = snapshot.val();
    if(val){
        for(const rec of Object.values(val)){
            if(rec.startBy === (currentUser.name || currentUser.username) && rec.status === 'started'){
                return true; // NÃ¶bet var
            }
        }
    }
    return false; // NÃ¶bet yok
}
olayBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    const hasNobet = await checkActiveNobet();
    if(!hasNobet){
        showWarningModal("Olay Bildirmek iÃ§in Ã¶nce nÃ¶beti almalÄ±sÄ±nÄ±z!");
        return;
    }
    window.location.href = 'olay.html';
});
const profileBtn = document.getElementById("profileBtn");
const profileModal = document.getElementById("profileModal");
const profileClose = document.getElementById("profileClose");
const profileUsername = document.getElementById("profileUsername");
const oldPassword = document.getElementById("oldPassword");
const newPassword = document.getElementById("newPassword");
const phoneNumber = document.getElementById("phoneNumber");
const updateProfileBtn = document.getElementById("updateProfileBtn");
const profileMessage = document.getElementById("profileMessage");
const logoutTopBtn = document.getElementById("logoutTopBtn");
oldPassword.addEventListener('input', ()=>{
    oldPassword.value = oldPassword.value.toUpperCase();
});
newPassword.addEventListener('input', ()=>{
    newPassword.value = newPassword.value.toUpperCase();
});

profileUsername.value = currentUser.name || currentUser.username || "";

profileBtn.addEventListener('click', ()=>{ profileModal.style.display='block'; });
profileClose.addEventListener('click', ()=>{ profileModal.style.display='none'; });

updateProfileBtn.addEventListener('click', async ()=> {
  profileMessage.innerText='';
  if(!oldPassword.value && !newPassword.value && !phoneNumber.value) return;

  const key = currentUser.username;
  const userRef = ref(db, 'users/'+key);

  const snapshot = await get(userRef);
  const user = snapshot.val();
  if(!user){ profileMessage.innerText="KullanÄ±cÄ± bulunamadÄ±."; return; }

  if(oldPassword.value && oldPassword.value !== user.password){
    profileMessage.innerText="Eski ÅŸifre hatalÄ±!"; return;
  }

  const updates = {};
  if(newPassword.value) updates.password = newPassword.value;
  if(phoneNumber.value) updates.phone = phoneNumber.value;

  await update(userRef, updates);
  profileMessage.innerText="Profil baÅŸarÄ±yla gÃ¼ncellendi!";
  oldPassword.value=''; newPassword.value=''; phoneNumber.value='';
  if(updates.password) currentUser.password = updates.password;
  if(updates.phone) currentUser.phone = updates.phone;
  sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
});
// Åifre gÃ¶ster/gizle gÃ¶z simgesi
document.querySelectorAll('.togglePassword').forEach(el=>{
  el.addEventListener('click', ()=>{
    const input = document.getElementById(el.dataset.target);
    if(input.type === "password"){
      input.type = "text";
      el.innerText = "ğŸ™ˆ"; // gÃ¶z kapalÄ± simgesi
    } else {
      input.type = "password";
      el.innerText = "ğŸ‘€"; // gÃ¶z aÃ§Ä±k simgesi
    }
  });
});
phoneNumber.addEventListener('input', () => {
    phoneNumber.value = phoneNumber.value.replace(/\D/g, ''); // sadece rakam bÄ±rak
});
logoutTopBtn.addEventListener('click', ()=>{
  sessionStorage.removeItem('currentUser');
  window.location.href = "index.html";
});
/* === Panel elemanlarÄ± === */
const nobetAlBtn = document.getElementById("nobetAlBtn");
const nobetBitirBtn = document.getElementById("nobetBitirBtn");
const nobetStatus = document.getElementById("nobetStatus");
const devriyeStartBtn = document.getElementById("devriyeStartBtn");
const devriyeEndBtn = document.getElementById("devriyeEndBtn");
const devriyeStatus = document.getElementById("devriyeStatus");
const devriyeHistoryEl = document.getElementById("devriyeHistory");
const filterDate = document.getElementById("filterDate");
const historyToggleBtn = document.getElementById("historyToggleBtn");
const historyPanel = document.getElementById("historyPanel");
const mainContainer = document.getElementById("mainContainer");
const qrListContainer = document.getElementById('qrListContainer');
nobetAlBtn.addEventListener('click', (e)=>{ 
  e.stopImmediatePropagation(); // diÄŸer click listenerlarÄ± engeller
  window.location.href = "nobet.html";
});
nobetBitirBtn.addEventListener('click', (e)=>{ 
  e.stopImmediatePropagation();
  window.location.href = "nobet.html";
});
const qrModal = document.getElementById('qrScannerModal');
const qrReaderDivId = 'qr-reader';
const closeScanner = document.getElementById('closeScanner');
let qrScanner = null;

let devriyeStarted = false;
let devriyeStartTime = null;
let readPoints = [];
let allDevriyeHistory = [];

// 2ï¸âƒ£ Devriye durumunu dinleme
// 2ï¸âƒ£ Devriye durumunu dinleme
onValue(activeDevriyeRef, snapshot => {
    const val = snapshot.val();
    if(val){
        // Aktif devriye varsa parlamayÄ± sÃ¶ndÃ¼r
        devriyeStartBtn.classList.remove('pulse-blue'); 
        
        devriyeStarted = true;
        devriyeStartTime = new Date(val.startTime);
        readPoints = Array.isArray(val.readPoints) ? val.readPoints : [];
        devriyeEndBtn.disabled = false;
        startDevriyeTimer();
        // Sayfa yenilendiÄŸinde butonlarÄ± yeÅŸile Ã§evirmek iÃ§in:
        setTimeout(updateQRButtons, 500); 
    } else {
        // Aktif devriye yoksa parlamayÄ± baÅŸlat
        devriyeStarted = false;
        devriyeStartBtn.classList.add('pulse-blue');
        
        // Timer ve butonlarÄ± da sÄ±fÄ±rlayalÄ±m (tedbir amaÃ§lÄ±)
        devriyeStatus.innerText = "Devriye bekleniyor...";
        devriyeEndBtn.disabled = true;
    }
});
function updateQRButtons(){
  document.querySelectorAll('.qrBtn').forEach(btn=>{
    const pointName = btn.dataset.point;
    // readPoints iÃ§indeki objelerde bu isim var mÄ± diye bakÄ±yoruz
    const isRead = readPoints.some(p => p.name === pointName);
    
    if(isRead){
      btn.classList.add('read');
      btn.nextElementSibling.innerText='TamamlandÄ±';
    } else {
      btn.classList.remove('read');
      btn.nextElementSibling.innerText = pointName;
    }
  });
}
let devriyeTimerInterval = null;
function startDevriyeTimer(){
  if(devriyeTimerInterval) clearInterval(devriyeTimerInterval);
  devriyeTimerInterval = setInterval(()=>{
    if(!devriyeStarted) return;
    const now = new Date();
    const diff = Math.floor((now - devriyeStartTime)/1000);
    const h = String(Math.floor(diff/3600)).padStart(2,'0');
    const m = String(Math.floor((diff%3600)/60)).padStart(2,'0');
    const s = String(diff%60).padStart(2,'0');
    devriyeStatus.innerText = `ğŸŸ¢ Devriye BaÅŸladÄ± | â±ï¸${h}:${m}:${s}`;
  },1000);
}
const nobetRecordsRef = ref(db,'nobetRecords');
onValue(nobetRecordsRef, snapshot=>{
  const val = snapshot.val();
  let activeRecord = null;

  if(val){
    Object.values(val).forEach(rec=>{
      if(rec.startBy === (currentUser.name || currentUser.username) && rec.status==='started'){
        activeRecord = rec;
      }
    });
  }
  let nobetTimerInterval = null;
if(activeRecord){
  nobetStatus.innerText = `ğŸ‘® ${activeRecord.startBy} | ğŸ§­ ${activeRecord.startPoint} - NÃ¶bettesin`;
  nobetAlBtn.disabled = true;
  nobetBitirBtn.disabled = false;
  // SayaÃ§
  const startTime = new Date(activeRecord.startTime);
  clearInterval(nobetTimerInterval);
  nobetTimerInterval = setInterval(()=>{
    const now = new Date();
    const diff = Math.floor((now - startTime)/1000); // saniye
    const h = String(Math.floor(diff/3600)).padStart(2,'0');
    const m = String(Math.floor((diff%3600)/60)).padStart(2,'0');
    const s = String(diff%60).padStart(2,'0');
    document.getElementById("nobetTimer").innerText = `â±ï¸ SÃ¼re: ${h}:${m}:${s}`;
  },1000);
} else {
  nobetStatus.innerText = 'HenÃ¼z nÃ¶bette deÄŸilsiniz.';
  document.getElementById("nobetTimer").innerText = '';
  nobetAlBtn.disabled = false;
  nobetBitirBtn.disabled = true;
  clearInterval(nobetTimerInterval);
}
});
/* === NÃ¶bet al/bitir butonlarÄ± === */
nobetAlBtn.addEventListener('click', ()=>{ 
  const newRecord = {
    fromSecurity: currentUser.username || currentUser.name,
    startBy: currentUser.name || currentUser.username,
    startPoint: 'D BLOK', // opsiyonel, isteÄŸe gÃ¶re
    startTime: new Date().toISOString(),
    status: 'started'
  };
  push(nobetRecordsRef, newRecord);
});
nobetBitirBtn.addEventListener('click', ()=>{
  // aktif nÃ¶beti bul ve status'u deÄŸiÅŸtir
  const valSnapshot = get(nobetRecordsRef);
  valSnapshot.then(snapshot=>{
    const val = snapshot.val();
    if(val){
      Object.entries(val).forEach(([key, rec])=>{
        if(rec.startBy === (currentUser.name || currentUser.username) && rec.status==='started'){
          update(ref(db,'nobetRecords/'+key), {status:'ended', endTime:new Date().toISOString()});
        }
      });
    }
  });
});
function showWarningModal(message, duration=3000){
    const modal = document.getElementById('warningModal');
    modal.innerText = message;
    modal.style.display = 'block';
    setTimeout(()=>{ modal.style.display = 'none'; }, duration);
}
devriyeStartBtn.addEventListener('click', async () => {
devriyeStartBtn.classList.remove('pulse-blue');
    const valSnapshot = await get(nobetRecordsRef);
    const val = valSnapshot.val();
    let activeNobet = null;
    if(val){
        Object.values(val).forEach(rec => {
            if(rec.startBy === (currentUser.name || currentUser.username) && rec.status === 'started'){
                activeNobet = rec;
            }
        });
    }
    if(!activeNobet){
        showWarningModal("Devriyeye BaÅŸlamak Ä°Ã§in Ã–nce NÃ¶beti Teslim Al");
        return; 
    }
    if(devriyeStarted) return;
	devriyeEndBtn.disabled = false;           // Butonu tekrar tÄ±klanabilir yap
    devriyeEndBtn.innerText = "Devriyeyi Bitir"; // YazÄ±sÄ±nÄ± sÄ±fÄ±rla
    devriyeEndBtn.style.backgroundColor = ""; // EÄŸer rengini deÄŸiÅŸtirdiysen sÄ±fÄ±rla
    devriyeEndBtn.dataset.loading = "false";
    devriyeStarted = true;
    devriyeStartTime = new Date();
    devriyeEndBtn.disabled = false;
    const snap = await get(activeDevriyeRef);

if(!snap.exists()){
    readPoints = [];
    await set(activeDevriyeRef, {
        startTime: devriyeStartTime.toISOString(),
        readPoints: []
    });
}
    function updateDevriyeStatus(){
        const now = new Date();
        const diff = Math.floor((now - devriyeStartTime)/1000);
        const h = String(Math.floor(diff/3600)).padStart(2,'0');
        const m = String(Math.floor((diff%3600)/60)).padStart(2,'0');
        const s = String(diff%60).padStart(2,'0');
        devriyeStatus.innerText = `ğŸŸ¢ Devriye BaÅŸladÄ± | â±ï¸${h}:${m}:${s}`;
    }
    updateDevriyeStatus();
    const devriyeTimerInterval = setInterval(() => {
        if(!devriyeStarted){
            clearInterval(devriyeTimerInterval);
            return;
        }
        updateDevriyeStatus();
    }, 1000);

    document.querySelectorAll('.qrBtn').forEach(btn => {
        btn.classList.remove('read');
        btn.nextElementSibling.innerText = btn.dataset.point;
    });
});

devriyeEndBtn.addEventListener('click', async () => {
    // 1. KONTROL: Zaten basÄ±ldÄ±ysa, devriye baÅŸlamadÄ±ysa veya buton kapalÄ±ysa Ã§Ä±k
    if (!devriyeStarted || devriyeEndBtn.disabled || devriyeEndBtn.dataset.loading === "true") return;

    // 2. KÄ°LÄ°TLEME: AnÄ±nda butonu kapat
    devriyeEndBtn.disabled = true; 
    devriyeEndBtn.dataset.loading = "true";
    devriyeEndBtn.innerText = "Ä°ÅŸleniyor...";

    const totalPoints = document.querySelectorAll('.qrBtn').length;
    const readCount = readPoints.length;

    // YardÄ±mcÄ± fonksiyon: Hem kaydÄ± yapar hem de butonu resetler
    const finalize = async () => {
        try {
            await finishDevriyeWithDate();
            // BaÅŸarÄ±lÄ± olursa buton zaten finishDevriyeWithDate iÃ§inde disabled kalacak
            devriyeEndBtn.innerText = "Devriye TamamlandÄ±"; 
        } catch (error) {
            console.error(error);
            alert("KayÄ±t sÄ±rasÄ±nda hata oluÅŸtu!");
            // Hata olursa butonu geri aÃ§
            devriyeEndBtn.disabled = false;
            devriyeEndBtn.dataset.loading = "false";
            devriyeEndBtn.innerText = "Devriyeyi Bitir";
			devriyeStartBtn.classList.add('pulse-blue');
        }
    };

    if (readCount < totalPoints) {
        showConfirmModal(
            `Devriyeyi Bitirmek Ä°stiyorsunuz. Fakat ${totalPoints - readCount} Nokta Eksik!`,
            async () => { 
                // KullanÄ±cÄ± onay verdi
                await finalize();
            },
            () => { 
                // KullanÄ±cÄ± Ä°PTAL etti -> Butonu eski haline getir
                devriyeEndBtn.disabled = false;
                devriyeEndBtn.dataset.loading = "false";
                devriyeEndBtn.innerText = "Devriyeyi Bitir";
            }
        );
    } else {
        // Noktalar tam ise doÄŸrudan bitir
        await finalize();
    }
});
async function finishDevriyeWithDate() {
    const devriyeEndTime = new Date(); // ğŸ”¹ BitiriÅŸ zamanÄ±
    const totalPoints = document.querySelectorAll('.qrBtn').length;
    const readCount = readPoints.length;
    
    // 1ï¸âƒ£ Durum Belirleme
    const statusText = (readCount > 0 && readCount === totalPoints) ? "Tam devriye" : "Eksik devriye";
    
    // 2ï¸âƒ£ Blok (startPoint) Bilgisini NÃ¶bet KaydÄ±ndan Ã‡ekme
    let blockName = "Bilinmiyor";
    try {
        const nobetSnapshot = await get(nobetRecordsRef);
        if (nobetSnapshot.exists()) {
            const records = nobetSnapshot.val();
            // Mevcut kullanÄ±cÄ±nÄ±n 'started' durumundaki nÃ¶betini bul
            for (const key in records) {
                const rec = records[key];
                if (rec.startBy === (currentUser.name || currentUser.username) && rec.status === 'started') {
                    blockName = rec.startPoint || "Bilinmiyor";
                    break;
                }
            }
        }
    } catch (err) {
        console.error("Blok bilgisi alÄ±nÄ±rken hata:", err);
    }

    // 3ï¸âƒ£ Tarih ve Format Ä°ÅŸlemleri
    const year = devriyeEndTime.getFullYear();
    const month = String(devriyeEndTime.getMonth() + 1).padStart(2, '0');
    const day = String(devriyeEndTime.getDate()).padStart(2, '0');
    const dateKey = `${year}-${month}-${day}`; 
    
    const weekday = devriyeEndTime.toLocaleDateString('tr-TR', { weekday: 'long' });
    const displayDate = `${devriyeEndTime.toLocaleDateString('tr-TR')} (${weekday.charAt(0).toUpperCase() + weekday.slice(1)})`;

    // 4ï¸âƒ£ Firebase'e Gidecek Veri Paketi (block eklendi)
    const devriyeRecord = {
        user: currentUser.username || currentUser.name,
        name: currentUser.name || currentUser.username,
        block: blockName, // ğŸš€ Eksik olan blok kaydÄ± eklendi
        start: devriyeStartTime.toLocaleTimeString('tr-TR'),
        end: devriyeEndTime.toLocaleTimeString('tr-TR'),
        status: statusText,
        points: [...readPoints],
        timestamp: Date.now(),
        displayDate: displayDate
    };

    // 5ï¸âƒ£ KayÄ±t ve Temizlik Ä°ÅŸlemleri
    try {
        const userKey = currentUser.username || currentUser.name;
        const dailyRef = ref(db, `devriyeHistory/${dateKey}/${userKey}`);
        
        await push(dailyRef, devriyeRecord); // GeÃ§miÅŸe ekle
        await set(activeDevriyeRef, null);    // Aktif devriyeyi temizle
        
        // ArayÃ¼zÃ¼ SÄ±fÄ±rla
        devriyeStarted = false;
        devriyeEndBtn.disabled = true;
		devriyeStartBtn.classList.add('pulse-blue');
        devriyeStatus.innerText = 'Devriye tamamlandÄ± ve kaydedildi.';
        
        document.querySelectorAll('.qrBtn').forEach(btn => {
            btn.classList.remove('read');
            if (btn.dataset.point) {
                btn.nextElementSibling.innerText = btn.dataset.point;
            }
        });

        // GeÃ§miÅŸ listesini otomatik yenile (opsiyonel)
        if (typeof loadDevriyeForDate === "function") {
            loadDevriyeForDate(dateKey);
        }

    } catch (error) {
        console.error("Devriye kaydedilirken hata oluÅŸtu:", error);
        alert("KayÄ±t sÄ±rasÄ±nda bir hata oluÅŸtu. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.");
    }
}
async function loadDevriyeForDate(dateKey){
    devriyeHistoryEl.innerHTML = 'YÃ¼kleniyor...';
    const userKey = currentUser.username || currentUser.name;
    const dailyRef = ref(db, `devriyeHistory/${dateKey}/${userKey}`);
    const snapshot = await get(dailyRef);
    const records = snapshot.exists() ? Object.values(snapshot.val()).sort((a,b)=> (b.timestamp||0)-(a.timestamp||0)) : [];
    devriyeHistoryEl.innerHTML = '';
    if(records.length===0){
        devriyeHistoryEl.innerHTML = `<div style="text-align:center; color:#ecf0f1;">Bu tarihe ait devriye kaydÄ± yok.</div>`;
        return;
    }
    records.forEach(d=>{
        const item=document.createElement('div');
        item.classList.add('devriye-item');
        item.style.marginBottom='10px';
        item.style.padding='10px';
        item.style.background='rgba(44,62,80,0.6)';
        item.style.borderRadius='10px';
        item.style.fontSize='14px';
        let statusHtml = "";
        if(d.status==="Eksik devriye"){
            statusHtml = `<span style="color:#e74c3c; font-weight:800;">âŒ EKSÄ°K DEVRÄ°YE</span>`;
        } else {
            statusHtml = `<span style="color:#2ecc71; font-weight:800;">âœ… TAM DEVRÄ°YE</span>`;
        }

        item.innerHTML = `
          <strong>Tarih:</strong> ${d.displayDate}<br>
          <strong>Blok:</strong> ${d.name || 'Bilinmiyor'}<br>
          <strong>BaÅŸlangÄ±Ã§:</strong> ${d.start}<br>
          <strong>BitiÅŸ:</strong> ${d.end}<br>
          <strong>Durum:</strong> ${statusHtml}
        `;

        devriyeHistoryEl.appendChild(item);
    });
}
document.addEventListener('DOMContentLoaded', () => {
    // ğŸ”¹ BugÃ¼nÃ¼n tarihini al (00:01 geÃ§se bile yeni tarih)
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2,'0');
    const day = String(now.getDate()).padStart(2,'0');
    const todayKey = `${year}-${month}-${day}`; // 2026-02-16 gibi
    filterDate.value = todayKey;
    loadDevriyeForDate(todayKey);
});
filterDate.addEventListener('change', e => {
    const selectedDate = e.target.value;
    if (selectedDate) loadDevriyeForDate(selectedDate);
});
historyToggleBtn.addEventListener('click', ()=>{
  if(historyPanel.style.right==='0px'){
    historyPanel.style.right='-100%';
    mainContainer.style.transform='translateX(0)';
  } else {
    historyPanel.style.right='0';
    mainContainer.style.transform='translateX(-320px)';
  }
});
function hasCameraLib(){ return typeof Html5Qrcode !== 'undefined'; }
async function startScanner(pointName, btnEl){
  if(!devriyeStarted){ alert("Ã–nce devriyeyi baÅŸlatÄ±n!"); return; }
  if(!hasCameraLib()){ alert("QR kÃ¼tÃ¼phanesi yÃ¼klenemedi!"); return; }
  qrModal.style.display='flex';
  if(qrScanner) qrScanner.clear();
  qrScanner = new Html5Qrcode(qrReaderDivId);
  qrScanner.start(
    { facingMode:"environment" },
    { fps:10, qrbox:250 },
    async qrCodeMessage => {
      const qrId = qrCodeMessage.trim();
      if(qrId === btnEl.dataset.qrid){
        btnEl.classList.add('read');
        btnEl.nextElementSibling.innerText='TamamlandÄ±';
const now = new Date();
        const timeStr = now.getHours().toString().padStart(2, '0') + ":" + 
                        now.getMinutes().toString().padStart(2, '0');

        if(!readPoints.some(p => p.name === pointName)){
            readPoints.push({
                name: pointName,
                time: timeStr
            });
            // Firebase'e anlÄ±k kaydet (Yenilemede geri gelmesi iÃ§in kritik)
            await set(activeDevriyeRef, {
                startTime: devriyeStartTime.toISOString(),
                readPoints: readPoints
            });
        }
        qrScanner.stop();
        qrModal.style.display='none';
      } else {
        alert("QR kod eÅŸleÅŸmedi!");
      }
    },
    err=>{ /* console.log(err) */ }
  ).catch(err=>{ alert("Kamera aÃ§Ä±lamadÄ±: "+err); });
}
closeScanner.addEventListener('click', ()=>{
  if(qrScanner) qrScanner.stop();
  qrModal.style.display='none';
});
async function loadQRPoints() {
    try {
        const nobetSnapshot = await get(nobetRecordsRef);
        let startPoint = null;
        if(nobetSnapshot.exists()){
            const records = nobetSnapshot.val();
            for(const rec of Object.values(records)){
                if(rec.startBy === (currentUser.name || currentUser.username) && rec.status==='started'){
                    startPoint = rec.startPoint.trim();
                    break;
                }
            }
        }
		if(devriyeStarted){
    updateQRButtons();
}
        let pointsRef = startPoint ? ref(db, `${startPoint}qrcodes`) : null;
        let snapshot = pointsRef ? await get(pointsRef) : null;
        let pointsData = snapshot && snapshot.exists() ? snapshot.val() : null;
        if(!pointsData){
            pointsRef = ref(db,'qrCodes');
            snapshot = await get(pointsRef);
            pointsData = snapshot.exists() ? snapshot.val() : {};
        }
        qrListContainer.innerHTML = '';
        Object.values(pointsData).forEach(point=>{
            const div = document.createElement('div');
            const btn = document.createElement('button');
            btn.classList.add('qrBtn');
            btn.dataset.qrid = point.qrId;
            btn.dataset.point = point.name;
            btn.innerText = "QR Okut";
            const span = document.createElement('span');
            span.innerText = point.name;
if(readPoints.includes(point.name)){
    btn.classList.add('read');
    span.innerText = 'TamamlandÄ±';
}
            div.appendChild(btn);
            div.appendChild(span);
            qrListContainer.appendChild(div);
btn.addEventListener('click', ()=>{
    if(btn.classList.contains('read')){
        showWarningModal(
            "Bu nokta baÅŸarÄ±lÄ± bir ÅŸekilde okutulmuÅŸtur. LÃ¼tfen diÄŸer noktalarÄ± okutunuz.",
            2500
        );
        return;
    }
    startScanner(point.name, btn);
});
        });
    } catch(err){
        console.error("QR noktalarÄ± yÃ¼klenirken hata:", err);
        alert("QR noktalarÄ± yÃ¼klenemedi! Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.");
    }
}
// Sayfa yÃ¼klendiÄŸinde Ã§aÄŸÄ±r
document.addEventListener('DOMContentLoaded', loadQRPoints);
// Devriyeyi bitirme iÅŸlemi
async function finishDevriye(){
    const devriyeEndTime = new Date();
    const totalPoints = document.querySelectorAll('.qrBtn').length;
    const readCount = readPoints.length;
let statusText = (readCount > 0 && readCount === totalPoints) ? "Tam devriye" : "Eksik devriye";
    const weekday = devriyeStartTime.toLocaleDateString('tr-TR',{ weekday:'long' });
    const dateText = `${devriyeStartTime.toLocaleDateString()} (${weekday.charAt(0).toUpperCase()+weekday.slice(1)})`;
    // ğŸŸ¢ Blok bilgisini ekle
    let blockName = 'Bilinmiyor';
    const nobetSnapshot = await get(nobetRecordsRef);
    if(nobetSnapshot.exists()){
        const records = nobetSnapshot.val();
        for(const rec of Object.values(records)){
            if(rec.startBy === (currentUser.name || currentUser.username) && rec.status==='started'){
                blockName = rec.startPoint || 'Bilinmiyor';
                break;
            }
        }
    }
    const devriyeRecord = {
        user: currentUser.username || currentUser.name,
        name: currentUser.name || currentUser.username,
        block: blockName, // ğŸ”¹ burasÄ± eklendi
        date: devriyeStartTime.toISOString().split('T')[0],
        displayDate: dateText,
        start: devriyeStartTime.toLocaleTimeString(),
        end: devriyeEndTime.toLocaleTimeString(),
        status: statusText,
        points:[...readPoints],
        timestamp: Date.now()
    };
    const userDevriyeRef = ref(db,'devriyeHistory/'+(currentUser.username || currentUser.name));
    await push(userDevriyeRef, devriyeRecord);
    await set(activeDevriyeRef, null);
    devriyeStarted = false;
    devriyeEndBtn.disabled = true;
    devriyeStatus.innerText = 'Devriye tamamlandÄ±.';
    document.querySelectorAll('.qrBtn').forEach(btn=>{
        btn.classList.remove('read'); 
        btn.nextElementSibling.innerText=btn.dataset.point;
    });
}
// Modal gÃ¶sterme fonksiyonu
function showConfirmModal(message, onConfirm, onCancel){
    let modal = document.getElementById('confirmModal');
    if(!modal){
        modal = document.createElement('div');
        modal.id = 'confirmModal';
        modal.style.cssText = `
            display:flex; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
            background: rgba(231,76,60,0.95); color:#fff; padding:20px; border-radius:16px;
            box-shadow:0 8px 24px rgba(0,0,0,0.4); z-index:9999; flex-direction:column;
            max-width:90%; width:auto; text-align:center;
        `;
        const msgEl = document.createElement('div'); msgEl.id='confirmMessage'; msgEl.style.marginBottom='16px';
        modal.appendChild(msgEl);
        const btnContainer = document.createElement('div'); btnContainer.style.display='flex'; btnContainer.style.justifyContent='space-around';
const btnFinish = document.createElement('button');
btnFinish.innerText = 'Devriyeyi Bitir';
btnFinish.style.cssText = 'background:#f1c40f;color:#000;padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:600;';
btnFinish.addEventListener('click', ()=>{ onConfirm(); modal.style.display='none'; });
const btnContinue = document.createElement('button');
btnContinue.innerText = 'Devriyeye Devam Et';
btnContinue.style.cssText = 'background:#27ae60;color:#fff;padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:600;';
btnContinue.addEventListener('click', ()=>{ onCancel(); modal.style.display='none'; });
        btnContainer.appendChild(btnFinish);
        btnContainer.appendChild(btnContinue);
        modal.appendChild(btnContainer);
        document.body.appendChild(modal);
    }
    document.getElementById('confirmMessage').innerText = message;
    modal.style.display='flex';
}
// ğŸ“Œ KAYIT BUTONUNU ADMÄ°N PANELÄ°NDEN KONTROL ET
const kayitBtn = document.getElementById("kayitBtn");
const kayitRef = ref(db, "panel/kayitAktif");
onValue(kayitRef, (snapshot) => {
  kayitBtn.style.display = snapshot.val() === true ? "inline-block" : "none";
});
document.getElementById("kayitBtn").addEventListener("click", () => {
  // giriÅŸ yapan gÃ¼venlik bilgisini diÄŸer sayfaya taÅŸÄ±
  sessionStorage.setItem("activeSecurity", currentUser.username || currentUser.name);
  window.location.href = "kayit.html";
});
const devriyePanelTitle = document.querySelector('.panel h2'); // Devriye baÅŸlÄ±ÄŸÄ±
const qrContainers = document.querySelectorAll('.qr-list > div'); // QR kutularÄ±
function handleConnectionChange(){
    if(navigator.onLine){
        nobetStatus.classList.remove('blink-red');
        qrContainers.forEach(c => c.classList.remove('blink-red'));
        devriyePanelTitle.classList.remove('offlineTextBlink');
        devriyePanelTitle.innerText = 'Devriye';
    } else {
        nobetStatus.classList.add('blink-red');
        qrContainers.forEach(c => c.classList.add('blink-red'));
        devriyePanelTitle.classList.add('offlineTextBlink');
        devriyePanelTitle.innerText = 'â—â— Offline GÃ¼venli Mod Aktif â—â—'; // iki taraf Ã¼nlem
    }
}
// Sayfa yÃ¼klendiÄŸinde kontrol et
handleConnectionChange();
// Online / offline event listener
window.addEventListener('online', handleConnectionChange);
window.addEventListener('offline', handleConnectionChange);
let flashOn = false;
document.getElementById('flashToggle').addEventListener('click', async () => {
  if(!qrScanner) return;
  try{
    flashOn = !flashOn;
    await qrScanner.applyVideoConstraints({
      advanced: [{ torch: flashOn }]
    });
    document.getElementById('flashToggle').innerText =
      flashOn ? 'ğŸ”¦ FlaÅŸ Kapat' : 'ğŸ”¦ FlaÅŸ AÃ§';
  }catch(e){
    showWarningModal("Bu cihaz flaÅŸÄ± desteklemiyor");
  }
});
</script>
</body>
</html>
